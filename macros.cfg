# =======================
#   PRINT CONTROL MACROS
# =======================

[pause_resume]
[gcode_macro PAUSE]
description: Pause the current print
rename_existing: BASE_PAUSE
gcode:
    {% set x = params.X|default(10)|float %}
    {% set y = params.Y|default(10)|float %}
    {% set z = params.Z|default(10)|float %}
    {% set e = params.E|default(1)|float %}
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{e} F2100
    G1 Z{z} F600
    G90
    G1 X{x} Y{y} F6000

[gcode_macro RESUME]
description: Resume the current print
rename_existing: BASE_RESUME
gcode:
    {% set e = params.E|default(1)|float %}
    G91
    G1 E{e} F2100
    G90
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME

[gcode_macro CANCEL_PRINT]
description: Cancel the current print
rename_existing: BASE_CANCEL_PRINT
gcode:
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT

# =======================
#   FILAMENT MACROS
# =======================

[gcode_macro LOAD_FILAMENT]
description: Load filament
gcode:
    {% set e = params.E|default(100)|float %}
    M83
    G1 E{e} F300
    G1 E20 F150
    M82

[gcode_macro UNLOAD_FILAMENT]
description: Unload filament
gcode:
    {% set e = params.E|default(100)|float %}
    M83
    G1 E-{e} F300
    G1 E-20 F150
    M82

[gcode_macro M600]
description: Filament change
gcode:
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE X=10 Y=10 Z=10
    G91
    G1 E-50 F1000
    G90
    RESTORE_GCODE_STATE NAME=M600_state

# =======================
#   PREHEAT MACROS
# =======================

[gcode_macro PREHEAT_PLA]
description: Preheat for PLA
gcode:
    M140 S60         ; set bed temp
    M104 S200        ; set nozzle temp
    M190 S60         ; wait for bed
    M109 S200        ; wait for nozzle

[gcode_macro PREHEAT_PETG]
description: Preheat for PETG
gcode:
    M140 S80
    M104 S240
    M190 S80
    M109 S240

[gcode_macro PREHEAT_ABS]
description: Preheat for ABS
gcode:
    M140 S100
    M104 S250
    M190 S100
    M109 S250

[gcode_macro COOL_DOWN]
description: Turn off heaters
gcode:
    M104 S0
    M140 S0

# =======================
#   UTILITY MACROS
# =======================

[gcode_macro SENSORLESS_HOME_X]
gcode:
    {% set HOME_CUR = 0.700 %}
    {% set driver_config = printer.configfile.settings['tmc2209 stepper_x'] %}
    {% set RUN_CUR = driver_config.run_current %}
    # Set current for sensorless homing
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CUR}
    # Pause to ensure driver stall flag is clear
    G4 P2000
    # Home
    G28 X0
    # Move away
    G90
    G1 X5 F1200
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CUR}

[gcode_macro TEST_SPEED]
description: Test maximum speed and accel
gcode:
    {% set speed = params.SPEED|default(300)|float %}
    {% set accel = params.ACCEL|default(3000)|float %}
    {% set iterations = params.N|default(5)|int %}
    SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel}
    G91
    {% for i in range(iterations) %}
      G1 X100 F{speed*60}
      G1 X-100 F{speed*60}
      G1 Y100 F{speed*60}
      G1 Y-100 F{speed*60}
    {% endfor %}
    G90

[gcode_macro COLOR_CHANGE]
description: Manual color change
gcode:
    M600

[gcode_macro BED_LEVELING]
description: Run Z tilt + bed mesh
gcode:
    G28
    Z_TILT_ADJUST
    BED_MESH_CALIBRATE
    G28 Z

[gcode_macro PURGE_NOZZLE]
description: Purge nozzle with a set amount of filament
gcode:
    {% set length = params.LENGTH|default(50)|int %}
    {% set speed = params.SPEED|default(1200)|int %}
    G92 E0
    G1 F{speed}
    G1 E{length}
    G92 E0

[gcode_macro WIPE_NOZZLE]
description: Wipe nozzle at edge of bed
gcode:
    G1 X0 Y0 F6000
    G1 Z0.3 F600
    G1 X200 E10 F1000

[gcode_macro PID_TUNE_HOTEND]
description: Calibrate PID for hotend / extruder
gcode:
    {% set temp = params.TEMP|default(200)|int %}
    M117 Starting PID tune for hotend to {temp}C...
    M104 S{temp}               ; set target temperature
    PID_CALIBRATE HEATER=extruder TARGET={temp} CYCLE_TIME=5
    SAVE_CONFIG
    M117 Hotend PID tuning complete

[gcode_macro PID_TUNE_BED]
description: Calibrate PID for heated bed
gcode:
    {% set temp = params.TEMP|default(60)|int %}
    M117 Starting PID tune for bed to {temp}C...
    M140 S{temp}               ; set target temperature
    PID_CALIBRATE HEATER=heater_bed TARGET={temp} CYCLE_TIME=20
    SAVE_CONFIG
    M117 Bed PID tuning complete

[gcode_macro BED_LEVEL_QUICK]
description: Quick bed leveling check (Z tilt only)
gcode:
    G28
    Z_TILT_ADJUST

[gcode_macro PAUSE_FOR_FILAMENT]
description: Pause print for filament swap with retract and safe move
gcode:
    SAVE_GCODE_STATE NAME=FIL_SWAP
    BASE_PAUSE
    G91
    G1 E-5 F1200      ; retract slightly
    G1 Z10 F600       ; lift
    G90
    G1 X0 Y200 F6000  ; move to safe position

[gcode_macro RESUME_AFTER_FILAMENT]
description: Resume print after filament swap
gcode:
    RESTORE_GCODE_STATE NAME=FIL_SWAP MOVE=1
    BASE_RESUME

[gcode_macro SET_NOZZLE_TEMP]
description: Set nozzle temperature quickly
gcode:
    {% set temp = params.TEMP|default(200)|int %}
    M104 S{temp}

[gcode_macro SET_BED_TEMP]
description: Set bed temperature quickly
gcode:
    {% set temp = params.TEMP|default(60)|int %}
    M140 S{temp}

[gcode_macro FAN_ON]
description: Turn on fan to specific speed
gcode:
    {% set speed = params.SPEED|default(100)|int %}
    M106 S{speed}

[gcode_macro FAN_OFF]
description: Turn off fan
gcode:
    M107

[gcode_macro CALIBRATE_E_STEPS]
description: Calibrate extruder steps per mm
gcode:
    G92 E0
    G1 E100 F100       ; extrude 100mm filament
    G92 E0
    M117 Check measurement

[gcode_macro TEST_CUBE]
description: Print a small test cube for calibration
gcode:
    START_PRINT BED=60 EXTRUDER=200
    G1 X50 Y50 Z0.3 F6000
    ; Add cube G-code if needed or link to STL slice

[gcode_macro ENDSTOP_TEST]
description: Test all endstops
gcode:
    M117 Testing Endstops...
    G28 X0
    G28 Y0
    G28 Z0
    M117 Endstops test complete

[gcode_macro PARK]
description: Move head to a safe park position
gcode:
    M117 Parking...
    G91
    G1 Z10 F600               ; lift Z
    G90
    G1 X0 Y200 F6000          ; move to rear left corner (adjust if needed)
    M117 Parked

[gcode_macro FLOW_TEST]
description: Prints a single wall for flow calibration
gcode:
    {% set length = params.LENGTH|default(100)|int %}
    {% set speed = params.SPEED|default(60)|int %}
    G28
    G1 Z0.3 F6000
    G92 E0
    G1 X{length} E{length*0.05} F{speed*60} ; draw single extrusion line
    G92 E0

[gcode_macro SIMULATE_POWER_LOSS]
description: Pause print simulating power loss
gcode:
    SAVE_GCODE_STATE NAME=POWER_LOSS
    BASE_PAUSE
    M117 Simulating power loss...
    ; optionally move head away
    G91
    G1 Z10 F600
    G90

[gcode_macro RESUME_AFTER_POWER_LOSS]
description: Resume after simulated power loss
gcode:
    RESTORE_GCODE_STATE NAME=POWER_LOSS MOVE=1
    BASE_RESUME
    M117 Resumed print

[gcode_macro PAUSE_AT_LAYER]
description: Pause print at specified layer or Z height
gcode:
    {% set layer = params.LAYER|default(None) %}
    {% set z = params.Z|default(None) %}
    M117 Waiting to pause...
    ; Use slicer to insert this macro at layer or height
    PAUSE X=10 Y=10 Z=10

# =======================
#   START / END MACROS
# =======================

[gcode_macro START_PRINT]
description: Custom start print sequence
gcode:
    {% set BED_TEMP = params.BED|default(60)|int %}
    {% set EXTRUDER_TEMP = params.EXTRUDER|default(200)|int %}

    M117 Heating...
    M140 S{BED_TEMP}         ; set bed
    M104 S{EXTRUDER_TEMP}    ; set nozzle
    M190 S{BED_TEMP}         ; wait for bed
    M109 S{EXTRUDER_TEMP}    ; wait for nozzle

    M117 Homing...
    G28                      ; home all axes

    M117 Z tilt adjust...
    Z_TILT_ADJUST

    M117 Loading bed mesh...
    BED_MESH_PROFILE LOAD=default

    M117 Prime line...
    G92 E0
    G1 Z0.3 F6000
    G1 X5 Y5 F6000
    G1 X5 Y150 E15 F1200      ; prime line along left side
    G92 E0
    M117 Printing...

[gcode_macro END_PRINT]
description: Custom end print sequence
gcode:
    M117 Ending...
    M400                     ; wait for buffer
    G92 E0                   ; reset extrusion
    G1 E-3 F1800             ; retract filament a little
    G91
    G1 Z10 F600              ; lift nozzle
    G90
    G1 X0 Y200 F6000         ; park head
    M104 S0                  ; turn off nozzle
    M140 S0                  ; turn off bed
    M107                     ; turn off fan
    M84                      ; disable steppers
    M117 Done!
